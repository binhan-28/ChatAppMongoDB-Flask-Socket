<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
	<title>Home ChatBox</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->
	<link rel="icon" type="image/png" href="{{url_for('static', filename = 'images/icons/favicon.ico')}}"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'vendor/bootstrap/css/bootstrap.min.css')}}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'fonts/font-awesome-4.7.0/css/font-awesome.min.css')}}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'vendor/animate/animate.css')}}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'vendor/css-hamburgers/hamburgers.min.css')}}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'vendor/select2/select2.min.css')}}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/utils.css')}}">
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/mains.css')}}">
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/style.css')}}">
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/chat_style.css')}}">
	<link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/main_style.css')}}">
<!--===============================================================================================-->
</head>
<body>

	<div class="limiter">
		<div class="container-login100">
			<div id="container">
				  <aside>
					  <header>
						  <p>Member Of Room Chat</p>
					  </header>
					  <ul>
						  <div class="a">
							  {% for member in room_members %}
							  <li>
								  <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/chat_avatar_01.jpg" alt="">
								  {{ member._id.username }}
							  </li>
							  {% endfor %}
						  </div>

						  <form class="login100-form validate-form"  method="get" action="/home1">
							  <div class="container-login100-form-btn">
								  <button class="login101-form-btn" type="submit">
									  Go To Chat Home
								  </button>
							  </div>
						  </form>
					  </ul>


			  	</aside>
				<main>
					<header class="main-header">
						<img class="main-header-img" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/chat_avatar_01.jpg" alt="">
						<div class="main-header-div">
							<h2 class="main-header-h2">Welcome to chat room: {{ room.name }}</h2>
						</div>
						<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/ico_star.png" alt="">
					</header>
					<ul id="chat">
						<!-- Display message start-->
						<div id="display-message-section">
							<div id="messages">
								{% for message in messages %}
									<div><b>{{ message.sender }}&nbsp;[{{ message.created_at }}]:&nbsp;</b> {{ message.text }}</div>
								{% endfor %}
							</div>
							<!-- Get username -->
        					<span id="get-username">{{ username }}</span>
						</div>
						<!-- Display message end -->
					</ul>
					<form method="post">
						<footer>
							<div>
								<textarea id="message_input" placeholder="Type your message"></textarea>
								<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/ico_picture.png" alt="">
								<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/ico_file.png" alt="">
								<button class="main-footer-btn" type="submit">Send
									<svg class="svg-inline--fa fa-paper-plane fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="paper-plane" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M476 3.2L12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"></path></svg>
								</button>
							</div>
					</footer>
					</form>

				</main>
			</div>
		</div>
	</div>

<!--===============================================================================================-->
	<script src="{{url_for('static', filename = 'vendor/jquery/jquery-3.2.1.min.js')}}"></script>
<!--===============================================================================================-->
	<script src="{{url_for('static', filename = 'vendor/bootstrap/js/popper.js')}}"></script>
	<script src="{{url_for('static', filename = 'vendor/bootstrap/js/bootstrap.min.js')}}"></script>
<!--===============================================================================================-->
	<script src="{{url_for('static', filename ='vendor/select2/select2.min.js')}}"></script>
<!--===============================================================================================-->
	<script src="{{url_for('static', filename = 'vendor/tilt/tilt.jquery.min.js')}}"></script>
	<script >
		$('.js-tilt').tilt({
			scale: 1.1
		})
	</script>
<!--===============================================================================================-->
	<script src="{{url_for('static', filename = 'js/main.js')}}"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>

	<!-- Custom chat JS -->
        <script src="{{ url_for('static', filename='scripts/chat_page.js') }}"></script>

        <!-- SocketIO JS -->
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

        <!-- Custom SocketIO JS -->
        <script src="{{ url_for('static', filename='scripts/socketio.js') }}"></script>

        <!-- Bootstrap -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        <!-- Font Awesome JS -->
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>

	<script>
		const socket = io.connect("http://127.0.0.1:5000");

		socket.on('connect', function () {
			socket.emit('join_room', {
				username: "{{ username }}",
				room: "{{ room._id }}"
			});

			let message_input = document.getElementById('message_input');

			document.getElementById('message_input_form').onsubmit = function (e) {
				e.preventDefault();
				let message = message_input.value.trim();
				if (message.length) {
					socket.emit('send_message', {
						username: "{{ username }}",
						room: "{{ room._id }}",
						message: message
					})
				}
				message_input.value = '';
				message_input.focus();
			}
		});

		let page = 0;

		document.getElementById("load_older_messages_btn").onclick = (e) => {
			page += 1;
			fetch("/rooms/{{ room._id }}/messages?page=" + page, {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
				}
			}).then(response => {
				response.json().then(messages => {
					messages.reverse().forEach(message => prepend_message(message.text, message.sender, message.created_at));
				})
			})
		};

		function prepend_message(message, username, created_at) {
			const newNode = document.createElement('div');
			newNode.innerHTML = `<b>${username}&nbsp;[${created_at}]:&nbsp;</b> ${message}`;
			const messages_div = document.getElementById('messages');
			messages_div.insertBefore(newNode, messages_div.firstChild);
		}

		window.onbeforeunload = function () {
			socket.emit('leave_room', {
				username: "{{ username }}",
				room: "{{ room._id }}"
			})
		};

		socket.on('receive_message', function (data) {
			console.log(data);
			const newNode = document.createElement('div');
			newNode.innerHTML = `<b>${data.username}&nbsp;[${data.created_at}]:&nbsp;</b> ${data.message}`;
			document.getElementById('messages').appendChild(newNode);
		});

		socket.on('join_room_announcement', function (data) {
			console.log(data);
			if (data.username !== "{{ username }}") {
				const newNode = document.createElement('div');
				newNode.innerHTML = `<b>${data.username}</b> has joined the room`;
				document.getElementById('messages').appendChild(newNode);
			}
		});

		socket.on('leave_room_announcement', function (data) {
			console.log(data);
			const newNode = document.createElement('div');
			newNode.innerHTML = `<b>${data.username}</b> has left the room`;
			document.getElementById('messages').appendChild(newNode);
		});
</script>

</body>
</html>